# Тестовое задание для стажёра Backend (осенняя волна 2025)
## Сервис назначения ревьюеров для Pull Request’ов

### Запуск через Docker (рекомендуемый способ)
Требуется установленный Docker (Desktop / Engine).
из корня репозитория ввести команду 
make docker-up (или docker compose up --build)

она поднимет PostgreSQL, соберёт и запустит Go-сервис, применит миграции при старте.

Сервис будет доступен по адресу: http://localhost:8080

остановить при помощи команды:
make docker-down (или docker compose down -v)

Полезные команды Makefile
make build      # локальная сборка бинаря ./bin/server
make run        # запуск локально (нужна своя PostgreSQL и переменные HTTP_PORT, DB_DSN)
make docker-up  # поднять сервис и БД в Docker
make docker-down# остановить контейнеры и удалить volume
make lint       # прогнать golangci-lint

### Архитектурно код разделён на слои:
**repository** — чистый доступ к БД; не знает про HTTP.
**service** — доменная логика и проверки.  
**httpapi** — преобразование HTTP-запросов в вызовы сервиса и маппинг ошибок в HTTP-коды.


Миграции применяются автоматически при старте сервиса

### Реализованы все методы из openapi.yml:

Команды

POST /team/add — создать команду с участниками (создаёт/обновляет пользователей; при существующей команде возвращает ошибку TEAM_EXISTS).

GET /team/get — получить команду и её участников.

Пользователи

POST /users/setIsActive — изменить флаг активности пользователя.

GET /users/getReview — получить PR’ы, где пользователь назначен ревьювером.

PR

POST /pullRequest/create — создать PR и автоматически назначить до 2 активных ревьюверов из команды автора (автор не может быть ревьювером собственного PR).

POST /pullRequest/merge — пометить PR как MERGED (операция идемпотентна).

POST /pullRequest/reassign — заменить одного ревьювера на другого активного участника его команды, с соблюдением всех правил из ТЗ.

Дополнительно реализовано:

GET /stats/reviewers — простая статистика: количество назначений по ревьюверам.

POST /team/deactivateAndReassign — массовая деактивация пользователей команды с безопасным переназначением ревью на открытых PR (см. ниже).

GET /health — простой health-check.



POST /team/deactivateAndReassign:

* деактивирует указанных пользователей команды (is_active = false);

* находит все открытые PR, где они являются ревьюверами;

* для каждого PR пытается назначить нового активного ревьювера из этой же команды (по тем же правилам, что и в обычном /pullRequest/reassign);

* если кандидатов нет, неактивный ревьювер просто удаляется из PR (PR может остаться с 0/1 ревьювером, что допустимо по базовым правилам ТЗ).

* Возвращает сводку по количеству деактивированных пользователей, переназначенных и удалённых ревьюверов, а также числу затронутых PR.

GET /stats/reviewers - возвращает список { user_id, review_count } по таблице назначений ревьюверов.

### спорные моменты из ТЗ/спеки и принятые решения.

1. /users/getReview и несуществующий пользователь

В OpenAPI описан только ответ 200.
Решение: при запросе с user_id, который не существует, сервис возвращает:

{

"user_id": "неизвестный id",

"pull_requests": []

}

То есть всегда 200 OK, без 404.

2. Коды ошибок для валидации / внутренних ошибок

В спеке перечислены только доменные коды:

TEAM_EXISTS, PR_EXISTS, PR_MERGED,

NOT_ASSIGNED, NO_CANDIDATE, NOT_FOUND.

Отдельного кода для внутренних ошибок или валидации нет.
Решение:

для доменных ошибок используются строго эти коды;

для невалидного JSON и отсутствующих query-параметров возвращается 400 с кодом NOT_FOUND и поясняющим message (например, "invalid json", "user_id is required"), чтобы не добавлять новые коды, отсутствующие в спецификации.

3. Расхождение old_user_id vs old_reviewer_id в /pullRequest/reassign

В схеме запроса указано поле old_user_id,
но в example в OpenAPI используется old_reviewer_id.

Решение: сервис поддерживает оба варианта:

если заполнен old_user_id — используется он;

если old_user_id пустой, но есть old_reviewer_id, используется он.

4. Массовая деактивация при отсутствии кандидатов

В дополнительном методе /team/deactivateAndReassign, если для конкретного PR
нет ни одного подходящего активного кандидата для замены ревьювера:

неактивный ревьювер удаляется из этого PR;

PR остаётся с меньшим числом ревьюверов (0 или 1).

Это согласуется с базовым правилом ТЗ: «Если доступных кандидатов меньше двух, назначается доступное количество (0/1)».

Статистика и health-check в OpenAPI

Эндпоинты /stats/reviewers и /health не описаны в выданной спецификации openapi.yml.
Решение: добавить их как необязательные улучшения.
Основной контракт тестового задания (Teams/Users/PR) при этом строго соблюдён.